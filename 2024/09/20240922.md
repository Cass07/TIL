## Real MySql 8.0

### MySQL 구조
- MySQL 엔진 
  - 커넥션 핸들러 : 클라이언트로부터의 접속 및 쿼리 요청을 처리
  - SQL 파서 : SQL 문장을 분석하고, 문법적 오류가 없는지 확인
  - 옵티마이저 : SQL 파서가 분석한 SQL 문장을 최적화

MySQL은 표준 SQL 문법을 지원흐므로 표준 문법에 따라 작성된 쿼리는 다른 DBMS에서도 사용 가능하다

- 스토리지 엔진
  - 요청된 SQL 문장을 분석하거나 최적화하고, 실제 데이터를 디스크 스토리지에 저장하거나, 스토리지로부터 데이터를 읽어오는 부분을 담당
  - 스토리지 엔진은 하나의 MySQL 서버에서 두 개 이상을 동시에 사용할 수도 있다

MySQL엔진 + 스토리지 엔진 = MySQL 서버  
쿼리를 실행하는 과정에서 MySQL 엔진은 SQL 파서 - SQL 옵티마이저 - SQL 실행기 작업만 실행하고, 스토리지 엔진은 데이터 읽기/쓰기 작업만 처리한다  
- MySQL은 부가기능을 추가할 수 있는 플러그이 모델을 채택하고 있는데, 스토리지 엔진 또한 플러그인으로 추가할 수 있다

- 플러그인 아키텍처를 대체하고자 8.0에서 컴포넌트 아키텍처를 제공한다





- 핸들러 API
  - MySQL 엔진의 쿼리 실행 시 데이터를 쓰거나 읽어야 할 경우에는 각 스토리지 엔진에 쓰기/읽기를 요청하는데, 이러한 요청을 핸들러 요청이라고 함
  - 여기서 사용되는 API를 핸들러 API라고 한다

### MySQL 스레딩 구조
MySQL 서버는 프로세스 기반이 아닌 스레드 기반으로 작동하고, 포그라운드 스레드와 백그라운드 스레드로 나뉨
- 포그라운드 스레드 (클라이언트 스레드)
  - 최소 MySQL 서버에 접속된 클라이언트의 수만큼 존재
  - 각 클라이언트 사용자가 요청하는 쿼리를 처리
  - 클라이언트 사용자가 작업을 마치고 커넥션을 종료하면, 해당 스레드는 스레드 캐시로 돌아감
    - 스래드 캐시에 일정 개수 이상의 대기 중인 스레드가 있다면, 대신 스레드를 종료시켜 스레드 캐시에 존재하는 스레드의 개수를 일정 개수 이하로 유지
  - 데이터를 MySQL의 데이터 버퍼나 캐시로부터 가져오며, 이곳에 없다면 직접 디스크의 데이터나 인덱스 파일로부터 데이터를 읽어와서 작업을 처리
  - MyISAM은 데이터를 디스크에 쓰는 작업까지 포그라운드 스레드가 처리하지만
  - InnoDB는 데이터를 디스크에 쓰는 작업을 백그라운드 스레드가 처리
  - = 사용자 스레드


- 백그라운드 스레드
  - InnoDB는 이하의 여러 작업을 백그라운드로 처리
    - Insert Buffer를 병합하는 스레드
    - 로그를 디스크로 기록하는 스레드
    - InnoDB 버퍼 풀의 데이터를 디스크에 기록하는 스레드
    - 데이터를 버퍼로 읽어 오는 스레드
    - 잠금, 데드락을 모니터링하는 스레드

사용자의 요청을 처리하는 도중 데이터의 쓰기 작업은 지연처리해도 되나, 읽기 작업은 지연처리해서는 안 된다  
따라서 일반적으로 쓰기 작업은 버퍼링해서 일괄 처리하도록 하며, InnoDB가 그런 식으로 처리한다  
MyISAM은 이와 달리 포그라운드 스레드에서 읽기까지 처리하므로, 쓰기 버퍼링 기능을 사용할 수 없다


### 메모리 할당 및 사용 구조
MySQL에서 사용되는 메모리 공간은 글로벌 메모리 영역과 로컬 메모리 영역으로 구문할 수 있다  
이 둘은 MySQL 서버에 존재하는 스레드들이 공유해서 사용하는 공간인지의 여부에 따라 구분된다


- 글로벌 메모리 영역
  - 클라이어늩 수와 무관하게 하나의 메모리 공간만 할당되나, 필요에 따라 2개 이상을 할당받는 경우도 있다 (다만 클라이언트의 수와는 무관계하다)
  - 생성된 글로벌 메모리 영역이 2개 이상이더라도, 모든 스레드에게 공유된다
  - 테이블 캐시, InnoDB 버퍼 풀, InnoDB 어댑티브 해시 인덱스, InnoDB 리두 로그 버퍼 등이 속한다


- 로컬 메모리 영역
  - 세션 메모리 형식이라고도 한다
  - 클라이언트 스레드가 쿼리를 처리하는 데 사용되는 메모리 영역
  - 로컬 메모리는 각 클라이언트 스레드별로 독립적으로 할당되며, 공유되지 않는다
  - 정렬 버퍼, 조인 버퍼, 바이너리 로그 캐시, 네트워크 버퍼 등이 속한다


### 쿼리 실행 구조
SQL요청이 들어오면 다음과 같은 순서로 작업 후 SQL 결과를 반환한다

1. 쿼리 파서
   - 사용자 요청으로 들어온 쿼리 문장을 토큰으로 분리해 트리 형태의 구조로 만들어 준다
   - 쿼리 문장의 기본 오류는 이 과정에서 발견된다
   - 토큰 : MySQL이 인식할 수 있는 최소 단위의 어휘나 기호
2. 전처리기
   - 파서 과정에서 만들어진 파서 트리를 기반으로 쿼리 문장에 구조적인 문제를 확인
   - 각 토큰을, 테이블 이름이나 컬럼 이름 내장 함수 등의 개체와 매핑에, 해당 객체의 존재 여부와 객체의 접근 권한 등을 확인
   - 실제 존재하지 않거나 권한상 사용할 수 없는 토큰은 이 과정에서 발견됨
3. 옵티마이저
   - 사용자의 요청으로 들어온 쿼리 문장을, 어떻게 적은 비용으로 가장 빠르게 처리할지를 결정
4. 쿼리 실행기
   - 실행 엔진을 호출
5. 쿼리 결과 반환


### 스레드 풀
내부적으로 사용자의 요청을 처리하는 스레드 개수를 줄여서, 동시에 들어오는 요청이 많더라도 CPU가 제한된 개수의 스레드 처리에만 집중할 수 있게 하여 서버의 자원 소모를 줄임  
단, 스케줄링을 효율적으로 할 수 없다면 처리 속도를 줄이기 어렵다  
MySQL 커뮤니티 에디션에는 기본저그올 지원하지 않으나 플러그인 라이브러리릅 별도로 설치하면 사용할 수 있다  

### 트랜잭션 지원 메타데이터
메타데이터(데이터 딕셔너리) : 테이블의 구조 정보와 스토어드 프로그램 등의 정보  
5.7 버전까지는 테이블의 구조는 FRM 파일에 저장하고 일부 스토어드 프로그램 또한 파일 기반으로 관리하였음
- 파일 기반의 메타데이터는 생성/변경 작업이 트랜잭션을 지원하지 않으므로, 생성/변경 도중 비정상적으로 서버가 종료되면 일관되지 않은 상태가 되어 데이터베이스가 "깨질" 수 있었음

8.0 버전부터는 이를 해결하기 위해 이러한 메타데이터가 트랜잭션을 지원하도록 모두 InnoDB테이블에 저장하도록 개선됨  
이러한 서버가 작동하는 데 기본적으로 필요한 테이블들은 시스템 테이블이라고 함.
- 이 시스템 테이블과 데이터 딕셔너리 정보를 모두 모아서 MySQL db로 저장하고, 이는 `mysql.ibd` 라는 이름의 테이블스페이스에 저장됨


다만 MyISAM이나 CSV 등과 같은 스토리지 엔진의 메타 정보는 여전히 별도로 저장할 공간이 필요  
- 이들을 위해 SDI(Serialized Dictionary Information)라는 파일을 사용