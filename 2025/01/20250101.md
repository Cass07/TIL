### Kubernetes란
- 컨테이너 오케스트레이션 도구로서, 컨테이너화된 애플리케이션을 자동으로 배포, 스케일링 및 관리하는 오픈소스 플랫폼

#### 특징
- 마스터 서버와 노드로 구성됨
- 마스터 서버
    - 클러스터의 노드들을 관리하는 서버
    - kube-apiserver - 클러스터의 API를 사용할 수 있도록 하는 컨트롤 플레인 컴포넌트
        - 대충 API 서버로서 요청이 유효한지 검증하고, 여러 컴포넌트 간 통신을 도와주는 역할
    - etcd - 쿠버네티스의 모든 데이터를 key-value 형태로 저장하는 데이터베이스 역할
        - 서버 하나당 하나의 etcd 서버가 동작하며, 모든 클러스터 데이터를 저장
    - kube-scheduler - 클러스터 내에서 자원 할당이 가능한 노드 중, 알맞은 노드를 선택하고 새로운 Pod를 배치하는 역할
    - kube-controller-manager - 클러스터의 상태를 모니터링하고, 상태를 조정하는 역할
    - cloud-controller-manager - 쿠버네티스의 컨트롤러를 클라우드 서비스와 연결해서 관리하는 컴포넌트
- 노드
    - 컨테이너화된 애플리케이션을 실행하는 실제 머신
    - kubelet - 모든 노드에서 실행되는 에이전트로, PodSpec을 전달받아 마스터로부터 할당받은 Pod를 실행을 관리하고 헬스체크를 진행
    - kube-proxy - 클러스터 내의 네트워크 프록시와 로드 밸런서를 구현하는 네트워크 프록시
    - 컨테이너 런타임 - 컨테이너를 실행하는 소프트웨어
        - Docker, containerd, CRI-O 등...

- 오브젝트
    - 쿠버네티스의 기본적인 구성 단위가 되는 기본 오브젝트와, 이를 관리하는 컨트롤러로 이루어짐
    - 오브젝트의 특성을 기술한 오브젝트 스펙으로 정의되며, cli를 통해 직접 생성하기도 하지만 보통 yaml 파일로 정의됨

- 기본 오브젝트
    - Namespace - 쿠버네티스 클러스터 내의 논리적인 구분 단위
        - 리눅스의 네임스페이스처럼 `논리적`으로 구분하는 단위이기에, 다른 네임스페이스 간 통신은 가능
    - Pod - 쿠버네티스의 기본 실행 단위
        - 하나 이상의 컨테이너로 구성되며, 컨테이너는 Pod 내에서 공유하는 네트워크와 스토리지를 사용
        - 같은 pod 내에 존재하는 컨테이너들은 localhost를 통해 통신이 가능하고, 디스크 볼륨을 공유할 수 있음
        - 파드의 생명 주기
            - Pending : 파드가 생성하는 중.
            - Running : 파드가 정상적으로 생성되어 실행 중.
            - Succeeded : 파드가 성공적으로 실행을 완료하고 종료됨
            - Failed : 파드가 실행 중에 일부 컨테이너에 문제가 발생하여 종료됨
            - Unknown : 파드의 상태를 알 수 없음
        - 파드의 condition
            - Ready : 파드가 서비스 요청을 받을 수 있는 상태
            - Initialized : 파드가 초기화되었는지 여부
            - Unschedulable : 파드가 스케줄링 될 수 있는지 여부
            - ContainersReady : 파드 내의 모든 컨테이너가 준비되었는지 여부
            - PodScheduled : 파드가 스케줄링 되었는지 여부
        - livenessProbe, readinessProbe 속성을 통해 컨테이너가 실행되었는지, 실행 후 정상적으로 동작하는지 확인하는 방법을 정의할 수 있음
    - Service - 파드의 집합에 대한 로드 밸런싱, 서비스 디스커버리, 파드의 라이프사이클 관리를 제공하는 오브젝트
        - 클러스터 내의 파드들을 논리적으로 그룹화하고, 이 그룹에 접근할 수 있는 방법을 제공
        - 서비스 타입
            - ClusterIP : 클러스터 내부에서만 접근 가능한 서비스
            - NodePort : 클러스터 외부에서 접근 가능한 서비스
            - LoadBalancer : 클라우드 서비스의 로드 밸런서를 사용하는 서비스
    - Volume - 파드에서 사용하는 디스크 볼륨을 정의하는 오브젝트
        - 파드가 종료되어도 데이터가 유지되도록 함
        - emptyDir, hostPath, nfs, gcePersistentDisk, awsElasticBlockStore, configMap, secret 등 다양한 타입이 존재

- 컨트롤러
    - 파드의 상태를 관리하고, 원하는 상태로 유지하기 위해 파드를 생성하고 삭제하는 역할
    - ReplicaSet - 파드의 복제본을 관리하는 오브젝트
        - 파드의 개수를 지정하고, 지정된 개수만큼 파드가 실행되도록 관리
        - 파드의 개수가 줄어들면 새로운 파드를 생성하고, 파드의 개수가 늘어나면 파드를 삭제
    - Deployment - ReplicaSet을 관리하는 오브젝트
        - ReplicaSet을 생성하고, ReplicaSet의 업데이트 전략을 지정
        - 업데이트 전략
            - Recreate : 기존 파드를 삭제하고 새로운 파드를 생성
            - RollingUpdate : 새로운 파드를 생성하고 기존 파드를 삭제하는 방식
            - Blue-Green Deployment : 새로운 버전의 파드를 생성하고, 트래픽을 새로운 파드로 전환
            - Canary Deployment : 새로운 버전의 파드를 일부만 생성하고, 트래픽을 일부 파드로 전환
        - 롤링 업데이트 전략
            - maxSurge : 최대로 생성할 파드의 개수
            - maxUnavailable : 최대로 삭제할 파드의 개수
    - DaemonSet - 클러스터의 모든 노드에 파드를 실행하는 컨트롤러
        - 로거나 모니터링용 데몬 등, 모든 노드에 실행되어야 하는 파드를 관리
    - StatefulSet - 파드에 고유한 식별자를 부여하고, 파드의 순서를 보장하는 컨트롤러
        - 데이터베이스나 메시징 시스템 등, 순서가 중요한 애플리케이션을 관리
        - `상태가 있는` 애플리케이션을 관리하기 위한 컨트롤러
            - 따라서, 종료되고 재실행되더라도 데이터가 유지됨
    - Job - 한 번 또는 주기적으로 실행되는 파드를 관리하는 컨트롤러
        - 한 번 실행되고 종료되는 파드를 관리
        - 파드가 성공적으로 종료되면, 해당 파드는 삭제
        - 파드가 실패하면, 재시도를 할 수 있음

#### 기본 개념
- 원하는 상태 (Desired State)를 정의하고, Kubernetes는 이 상태를 유지하기 위해서 현재 상태를 지속적으로 모니터링하며 변경함

- ex) 상태 변경을 통해 Pod가 생성되는 과정
  - Pod가 추가된 새로운 ReplicaSet을 정의
  - kubectl 도구를 사용해, API 서버에 replicaSet이 변경되었음을 통지
  - API 서버는 변경된 replicaSet을 etcd에 저장
  - kube-controller-manager는 etcd에 저장된 replicaSet을 확인하고, 변경된 replicaSet을 확인
  - kube-controller의 ReplicaSet 컨트롤러가, 정의된 Label Selector에 맞는 Pod가 존재하는 지 확인
  - 없다면 ReplicaSet의 Pod 템플릭을 확인하여 동일한 Pod를 생성 후 API server에 통지
  - API 서버는 etcd에 Pod 생성을 저장
  - Scheduler는 할당되지 않은 Pod가 있는지 확인하고, 할당되지 않은 Pod가 있다면 조건에 맞는 Node에 할당
  - kubelet은 Pod가 할당되었는지 확인하고, 되었다면 명세에 따라 Pod를 실행하고 컨테이너를 생성
  - kubelet은 Pod의 상태를 주기적으로 확인해 API 서버에 통지